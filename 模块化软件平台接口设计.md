#  模块化软件平台接口设计

## 模块化软件平台架构设计

模块化软件平台架构的设计如下图所示，整个软件平台主要分为1. CPU外设驱动层，2. 通用模块层，3. 功能逻辑层，4. 公共服务库。

### 1. CPU外设驱动层

该层包括所有可能需要用到的外设的驱动实现，为上层提供硬件驱动接口。该层与硬件架构密切相关，考虑到我们目前主要用到TI的C2000DSP系列和STM32系列两种硬件架构，因此CPU驱动层也会按照这两种硬件架构分为两个软件包，虽然不同硬件平台的驱动实现不同，但是为了上层程序的复用性考虑，应尽量保证驱动调用的接口一致。此外STM32提供的标准外设库比较完备，需要重新编码的工作较少。而C2000系列DSP虽然也有官方提供的C2000 ware库，但是其中提供的驱动很少，需要自行编码的工作很多。

### 2. 通用模块层

该层模块包括所有在项目中可能会用到的具体的功能模块的软件实现。例如不同流量传感器模块，比例阀控制模块，IP阀控制模块，涡轮控制模块，氧传感器模块等。这一层的软件代码应该尽最大可能做到通用和易移植。

### 3. 功能逻辑层

这一层的软件负责调用不同的模块以实现项目中会用到的一些具体的功能逻辑，如报警模块，不同的通气模式实现，通气参数监测功能，气道参数计算功能，通讯协议实现，自建功能实现等。

### 4. 公共服务库

公共服务库部分提供一些通用的数据结构和功能模块实现，这部分代码与任何项目解耦，可以直接被移植和调用。例如PI控制器，数字滤波器，限幅器，循环队列，栈，链表等。



## 驱动层接口设计(以DSP28335为例)

### CPU配置

- void InitSysCtrl(void)
  - 功能： 完成CPU初始化，包括系统时钟，CPU的外设时钟的配置。
  - 返回值: 无
  - 参数：  无 
  - 说明： 时钟的配置通过板级配置文件BSP中的宏定义实现
- void InitFlash(void)
  - 功能： 完成CPU片内flash的初始化，flash操作时序的配置
  - 返回值: 无
  - 参数：  无 
  - 说明： flash操作时序中的延时配置通过板级配置文件BSP中的宏定义实现。
- void  InitPeripheralClocks(void)
  - 功能： 完成CPU外设的初始化，包括高速和低速外设时钟总线的配置。
  - 返回值: 无
  - 参数：  无 
  - 说明： 时钟的配置通过板级配置文件BSP中的宏定义实现

### SCI/UART

- void InitSci(struct SciType SCIx, struct SciInitType *Init)

  - 功能： 初始化SCI外设模块。

  - 返回值： 无

  - 参数： SCIx: Sci外设寄存器结构体， 可以为Scia, Scib, Scic. Init: Sci外设初始化结构体

  - 说明： SciInitType结构体定义如下：

    ```c
    struct SciInitType {
    	Uint16	DataBits;
    	Uint16  StopBits;
    	enum ParitySel	Parity;
    	Uint16  SciIntSel;
    	Uint16  SciFifoMode;
    	Uint32	Baudrate;
    	Uint16  SciRxFifoLevel;
    	Uint16  SciTxFifoLevel;
    };
    ```

- int16 SciReadPoll(struct SciType *Scix, Uint16 *Buff, Uint16 Num)

  - 功能： 以查询的方式从SCI读取数据。
  - 返回值：如果有读到数据，返回读取的字节数。如果读数据失败返回负值的错误码。
  - 参数： Scix: Sci外设结构体指针，Buff: 读取数据的保存缓冲区， Num: 想要读取的字节数。
  - 说明：该方法会以查询的方式接收数据，但是不会阻塞，没有收到数据时也会立即返回。

- int16 SciWriteBlock(struct SciType *Scix, const Uint16 *Buff, Uint16 Num)

  - 功能：以阻塞的方式从SCI发送指定数据。
  - 返回值：成功发送数据的字节数。如果发送数据失败则返回负值的错误码。
  - 参数：Scix: Sci外设结构体指针，Buff: 发送数据的缓冲区， Num: 想要发送的字节数
  - 说明：该方法会阻塞的进行发送, 直到发送完毕或出现错误才会退出。

- void SciSendByte(struct SciType *Scix, Uint8 Data)

  - 功能： 通过Scix发送单个字节数据Data;
  - 参数： Scix: Sci外设结构体指针，Data: 要发送的单字节数据。
  - 返回值：无
  - 说明：无

- Uint8 SciRecvByte(struct SciType *Scix)

  - 功能： 通过Scix接收单个字节数据Data;
  - 参数： Scix: Sci外设结构体指针
  - 返回值： Scix接收到的单字节数据

### I2C

- void InitI2c(struct I2cType I2cx, struct I2cInitType *Init)
  - 功能： 初始化I2c外设模块。
  - 返回值： 无
  - 参数： I2cx: I2c外设结构体指针， 可以为I2ca. Init: I2c外设初始化结构体
  - 说明： I2cInitType结构体定义如下：

  ```c
  struct I2cInitType {
  	Uint16						Clock_kHz;
  	Uint16						I2cMode;
  	Uint16						I2cIntSrc;
  	Uint16						I2cFifoMode;
  	Uint16						I2cRxFifoLevel;
  	Uint16						I2cTxFifoLevel;
  };
  ```

- void I2cSendByte(struct I2cType I2cx, Uint8 Data)

  - 功能： 通过I2cx发送单字节数据
  - 返回值: 无
  - 参数： I2cx: I2c外设结构体指针， Data: 要发送的单字节数据
  - 说明：

- Uint8 I2cRecvByte(struct I2cType I2cx)

  - 功能： 通过I2cx接收单字节数据
  - 返回值: 接收到的单字节数据
  - 参数： I2cx: I2c外设结构体指针
  - 说明：

### ADC

- void InitAdc(struct AdcType Adcx, struct AdcInitType *Init)
  - 功能:  初始化外设模块Adcx
  - 返回值：无
  - 参数：Adcx：Adc结构体指针，可以为 Init: Adc初始化结构体指针
  - 说明：
- 

### PWM

- ​	void InitPwm(struct PwmType *Pwmx, struct PwmInitType *Init)

  - 功能：初始化外设模块Pwmx;
  - 返回值：无
  - 参数： Pwm: Pwm结构体指针， 可以为Pwm1, Pwm2, Pwm3, Pwm4, Pwm5, Pwm6。Init: Pwm模块初始化结构体指针。
  - 说明：PwmInitType结构体定义如下：

  ```c
  struct PwmInitType{
  	Uint32 			ClockHz;
  	Uint16			CounterPeriod;
  	Uint16			CounterMode;
  	Uint16 			PhaseDir;
  	Uint16 			SynOutSel;
  	Uint16			IntEn;
  	Uint16			IntMode;
  	Uint16			IntPeriod;
  	struct CAMP		cmpA;
  	struct CAMP		cmpB;
  }EPWM_T;
  ```

  

### SPI

​		



### 中断

- void InitPieCtrl()

### Timer





### 看门狗



## 通用服务层接口设计

### PI控制器



### 循环队列



### 链表



### 数字滤波器



### 状态机



## 通用模块层接口设计

### 报警模块



### 流量传感器



### 比例阀



### IP 阀



### 氧浓度传感器



### 涡轮





## 功能逻辑层接口设计

### 系统状态机



### 呼吸状态机



### 呼吸模式



### 参数监测



### 通信协议



### 压力控制



### 流量控制



### 氧浓度控制



### 潮气量控制



