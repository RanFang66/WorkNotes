# C语言编程规范

## 0 规范说明

### 0.1 规范制定目的

### 0.2 代码规范总体原则

### 0.3 规范实施



## 1 头文件

### 1.0头文件设计概述

C语言中的头文件相当于程序提供的对外的接口，体现的是软件架构的设计。实际开发时，在软件架构设计阶段会对软件进行分层和模块划分，同时会定义模块需要提供的对外接口，这些接口都是需要在模块的头文件中声明的，然后在软件详细设计阶段才会设计每一个模块功能包括对外接口的具体实现。因此一般是先定义好头文件然后再根据头文件中声明的接口去实现源文件的。

如果软件设计的模块化程度好，每个模块都应该有一个头文件向外提供所有需要用到的方法和数据的接口。所有需要用到这个模块的其他程序，只需要包含这个头文件，就可以调用模块中实现的方法完成任务。和面向对象编程类比，头文件可以实现封装的作用，头文件中的内容就是模块的公有（public）方法和公有属性，头文件不应该包含模块内部的私有（private）方法和私有属性。

### 1.1 头文件中的内容

头文件中只放置接口声明，不放置具体实现， 只放置调用者需要用到的变量和方法，不放置文件内部私有变量和方法。总之头文件中的内容遵循两点原则：

1. 只有声明，没有定义和实现，即不要在头文件中实现函数或者定义变量。
2. 最小化原则，只放置调用者可能会用到的函数，宏定义，数据类型和变量的声明，其他均不在头文件中开放。

头文件中一般包含以下内容：

- 其他文件中会调用的函数接口声明
- 其他文件中会调用的宏定义
- 其他文件中会调用的数据类型声明（struct，union，enum，typedef）
- 其他文件中会用到的全局变量声明（extern， 慎用）

容易存在的**错误做法**：

1. 源文件中所有的函数均在头文件中进行声明。

   头文件中只要声明其他文件需要用到的函数接口，对于一些只在源文件内部使用的子函数不要在头文件中开放，并且在源文件中用static 修饰。

2. 所有的宏定义都定义在头文件中。

   并不时所有的宏定义都需要定义在头文件中，同样，头文件中只需要定义其他调用文件需要用到的宏定义，对于一些源文件内部使用的宏定义直接定义在源文件中就可以了。

3. 所有全局变量都在头文件中用extern声明。

   全局变量要谨慎使用，在使用时也要尽量限制它的影响范围。对于一些只在源文件中会使用的，其他文件不会直接使用的全局变量，应当直接在源文件中定义，并用static修饰，而不是在源文件中定义之后，在头文件中用extern 声明。

### 1.2 头文件包含的原则

在包含头文件时，应当只包含需要用到的，同时要考虑稳定性，即如果所包含的头文件有所变化对于包含该头文件的源文件编译有何影响。

因此在进行头文件包含时需要考虑以下原则：

1. 尽量不要包含用不到的头文件。
2. 禁止头文件的循环依赖。
3. 头文件尽量自包含（自包含指的是源文件在包含该头文件时不必须依赖包含其他头文件就可以工作）。
4. 所有头文件内部都需要用#define进行头文件重复包含的保护。可以采用标准的命名格式：`PROJECT_PATH_FILENAME_H` 
5. 在进行头文件包含时，可以采用自底向上逻辑的顺序，即最基础，最不可能改动的部分最先包含。例如先包含C标准头文件，再包含MCU/DSP硬件定义头文件，再包含μC/OS头文件，再包含用户头文件。
6. 禁止在extern “C” 中包含头文件

**NOTICE**

华为编程规范中的头文件规范很多都是从减少编译时间的角度出发，但是我们的程序代码量不大，对于编译时间的优化要求没有那么强。因此一些规则上可以有所不同，例如头文件的包含顺序上就可以不用按照华为规范那样，而采用更符合逻辑的顺序。

上述原则中的第1条和第3条在实践中可能会存在矛盾，在华为编程规范建议头文件职责要单一，不要再头文件中包含很多其他头文件。但是在嵌入式编程中，对于硬件接口有很多头文件，如果每次编写代码都单独包含会给编码带来不便，因此可以编写一个头文件对所有的硬件抽象做包含。由于每个头文件都有重复包含的保护，因此这样做是安全的，能够方便编码，而带来的对编译时间上的影响很小。

对于应用程序部分的头文件包含还是应该独立包含，而不是用一个包含所有头文件的god.h。

华为编程规范中建议每一个模块单独再列一个头文件，给出模块的接口。在我们的代码中，代码量较小，一般一个模块就对应一个源文件。

## 2. 函数

函数是程序中实现单一功能的代码模块，函数设计应该要功能明确，接口清晰，函数的实现应该做到安全，稳定，简洁，高效，对于输入参数具备一定的鲁棒性。

### 2.1 函数设计原则：

1. 函数功能要明确且单一，一个函数只完成一个明确的功能。
2. 代码中出现的重复部分尽量提炼成函数，一般重复的代码或者结构出现三次时就可以考虑是否写成一个单独的函数了。
3. 函数的扇入，扇出要合理。一般函数的扇入要高，扇出不能太大（<7）。

###  2.2 函数实现的原则

1. 函数不应该太长，函数内的有效行数不应超过50行。
2. 函数内的代码块嵌套不应太深，函数内部的代码块嵌套深度不应该超过4层。
3. 对于需要可重入的函数应该避免使用全局变量，如果需要使用，需要采取保护措施（如信号量，关中断等）。
4. 对于函数中的不变参数，使用const做修饰。
5. 函数的参数格书不超过5个，并且同一个工程中的函数参数顺序要统一，例如输入参数在前，输出参数在后。

### 2.3 函数调用的原则：

1. 对于输入参数的合法性检查要统一，是在函数内检查还是由调用者检查。
2. 对函数的错误返回码的处理要全面，很多函数都会返回一个错误代码来表示函数执行过程的结果。对于调用者，应该要对函数的返回结果做检查。

## 3. 标识符命名与定义

### 3.0 命名风格概述

#### 3.0.1 命名风格之争

对于程序中的标识符命名，最重要的原则是在同一个项目中，**命名的风格要统一**。不同的命名风格各有优劣，但是无论哪一种风格，在同一个项目中命名风格应该要保持一致，否则会对维护带来困难。

常见的两种命名风格：

1. unix_like风格： 单词用小写字母，单词之间用下划线分割。如`salve_address`。
2. windows风格： 大小写字母混用，单词连在一起，每个字母首字母大写。 如 `SlaveAddress`。

以上两种风格都合理，最重要的是在同一项目下做到统一。个人偏向unix like风格，因为很多时候下划线的分割方式看起来会更清晰。

#### 3.0.2 关于标识符前加类型前缀

以前的很多项目中，在给变量命名时喜欢在名称最前端加上变量类型的前缀（匈牙利命名法）。通过这些前缀，如u8代表无符号八位整型，s16代表有符号16位整型，就能看出变量的类型。

但是这种做法在现在显然已经没有必要了。给变量名称引入这些前缀的目的是为了一眼能看出类型，但是在现代的开发环境中当鼠标或者光标移动到变量名上时都会直接提示变量类型，或者其他方式很方便的知道变量类型，因此这种做法已经没有太多意义，反而在需要修改变量类型时需要修改所有变量名称，带来很多麻烦。

### 3.1 通用命名原则

1. 同一项目内的命名风格要统一。

2. 标识符名称要有明确含义，使用完整的单词或者常用的可以理解的缩写拼写。（函数内部使用的临时循环变量或者一些作用域很小的临时变量可以使用简单字符。）

3. 对于常见的单词使用约定俗称的缩写，如下表所列：

   | buffer      | buff |
   | ----------- | ---- |
   | clock       | clk  |
   | control     | ctrl |
   | command     | cmd  |
   | maximum     | max  |
   | synchronize | sync |

   

4. 尽量避免命名中出现数字编号，因为只有数字不同，区分不够清晰，含义也不明确。

5. 标识符前不要用项目，产品，部门或者小组作为前缀，因为这样做不利于代码复用和维护。

### 3.2 文件命名规则

1. 统一采用小写字符

### 3.3 变量命名规则

1. 除了局部循环变量如i，j，k，禁止使用单字节命名变量。

### 3.4 函数命名规则

			1. 函数命名应以函数要执行的动作命名，一般采用动词或者动词＋名词的结构。  
   			2. 函数指针除了前缀，其他按照函数的命名规则命名。

### 3.5 宏定义命名规则

1. 对于数值或者字符串常量的宏定义，全部采用大写字母，单词之间用下划线分割，对于枚举变量，同样采用此命名方式。
2. 除了头文件或者编译开关等特殊宏定义，其他宏定义不要以下划线作为开头和结束。





